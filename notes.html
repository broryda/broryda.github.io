<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>노트 | 바둑 스터디</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* 아주 가벼운 마크다운 스타일 */
    .md p { margin: 0.5rem 0; }
    .md h1, .md h2, .md h3 { font-weight: 700; margin: 1rem 0 0.5rem }
    .md ul { list-style: disc; padding-left: 1.25rem; }
    .md code { background: #f3f4f6; padding: .1rem .3rem; border-radius: .25rem; font-family: ui-monospace, SFMono-Regular, Menlo, monospace }
    .note-row:hover { background: #f9fafb }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="border-b bg-white">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-lg font-semibold">바둑 스터디</a>
      <nav class="flex gap-4 text-sm">
        <a class="hover:underline" href="/schedule.html">일정</a>
        <a class="hover:underline" href="/notes.html" aria-current="page">노트</a>
        <a class="hover:underline" href="/about.html">소개</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">노트</h1>
      <div class="flex gap-2">
        <button id="export-json" class="px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">JSON 내보내기</button>
        <button id="export-md" class="px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">Markdown 내보내기</button>
        <label class="px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50 cursor-pointer">
          JSON 가져오기
          <input id="import-json" type="file" accept="application/json" class="hidden">
        </label>
        <button id="new" class="px-3 py-2 text-sm rounded-lg bg-black text-white hover:opacity-90">새 노트</button>
      </div>
    </div>

    <!-- Controls -->
    <section class="mb-4 flex flex-col sm:flex-row gap-3">
      <input id="q" type="search" placeholder="검색(제목/내용)" class="flex-1 px-3 py-2 rounded-lg border bg-white">
      <select id="sort" class="px-3 py-2 rounded-lg border bg-white">
        <option value="updated_desc">최근 수정순</option>
        <option value="title_asc">제목 A→Z</option>
      </select>
    </section>

    <!-- List -->
    <section id="list" class="rounded-xl border overflow-hidden bg-white">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr class="text-left">
            <th class="px-3 py-2 w-2/5">제목</th>
            <th class="px-3 py-2">미리보기</th>
            <th class="px-3 py-2 w-40">수정일</th>
            <th class="px-3 py-2 w-28"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="hidden p-10 text-center text-gray-500">노트가 없습니다. “새 노트”를 눌러 시작하세요.</div>
    </section>

    <!-- Editor -->
    <dialog id="dlg" class="w-full max-w-3xl rounded-xl p-0">
      <form method="dialog" class="p-0">
        <div class="flex items-center justify-between px-4 py-3 border-b bg-white rounded-t-xl">
          <h2 id="dlg-title" class="font-semibold">노트 편집</h2>
          <div class="flex gap-2">
            <button id="preview-toggle" type="button" class="px-3 py-1.5 text-sm rounded-lg border bg-white">미리보기</button>
            <button value="cancel" class="px-3 py-1.5 text-sm rounded-lg border bg-white">닫기</button>
            <button id="save" value="default" class="px-3 py-1.5 text-sm rounded-lg bg-black text-white">저장</button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
          <div class="p-4">
            <label class="block text-sm mb-1">제목</label>
            <input id="title" class="w-full px-3 py-2 rounded-lg border bg-white" />
            <label class="block text-sm mt-4 mb-1">내용 (Markdown 가능)</label>
            <textarea id="body" class="w-full h-80 px-3 py-2 rounded-lg border bg-white"></textarea>
          </div>
          <div id="preview" class="p-4 border-t lg:border-t-0 lg:border-l bg-gray-50 hidden">
            <div class="prose prose-sm max-w-none md"></div>
          </div>
        </div>
      </form>
    </dialog>
  </main>

  <!-- Footer -->
  <footer class="mt-16 border-t bg-white">
    <div class="mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500">
      © <span id="y"></span> 바둑 스터디
    </div>
  </footer>

  <script>
    const KEY = 'baduk_notes_v1';

    const state = {
      notes: load(),
      filter: { q: '', sort: 'updated_desc' },
      editingId: null,
    };

    // ---- storage ----
    function load() {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    }
    function persist() {
      localStorage.setItem(KEY, JSON.stringify(state.notes));
    }

    // ---- utils ----
    const $ = s => document.querySelector(s);
    const tbody = $('#tbody'), empty = $('#empty');

    function fmt(ts) {
      const d = new Date(ts);
      const z = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
    }

    // very tiny markdown (headings, lists, code, paragraphs)
    function md(str='') {
      let s = (str || '')
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      s = s.replace(/^### (.*)$/gm, '<h3>$1</h3>')
           .replace(/^## (.*)$/gm, '<h2>$1</h2>')
           .replace(/^# (.*)$/gm, '<h1>$1</h1>')
           .replace(/`([^`]+)`/g, '<code>$1</code>');
      // lists
      s = s.replace(/^(?:-|\*) (.*)$/gm, '<li>$1</li>');
      s = s.replace(/(<li>.*<\/li>)(?:(\n<li>.*<\/li>))+/gs, m => `<ul>${m}</ul>`);
      // paragraphs
      s = s.split(/\n{2,}/).map(b => /<(h\d|ul|li|code)/.test(b) ? b : `<p>${b.replace(/\n/g,'<br>')}</p>`).join('\n');
      return s;
    }

    // ---- render ----
    function render() {
      const { q, sort } = state.filter;
      let rows = state.notes
        .filter(n => {
          const t = (n.title||'').toLowerCase();
          const b = (n.body||'').toLowerCase();
          const qq = (q||'').toLowerCase();
          return !qq || t.includes(qq) || b.includes(qq);
        });

      rows.sort((a,b) => {
        if (sort === 'title_asc') return (a.title||'').localeCompare(b.title||'');
        return (b.updatedAt||0) - (a.updatedAt||0);
      });

      tbody.innerHTML = rows.map(n => `
        <tr class="note-row border-t">
          <td class="px-3 py-2 font-medium truncate">${n.title||'(제목 없음)'}</td>
          <td class="px-3 py-2 text-gray-600 truncate">${(n.body||'').replace(/\n/g,' ').slice(0,80)}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fmt(n.updatedAt || n.createdAt)}</td>
          <td class="px-3 py-2 text-right">
            <button class="px-2 py-1 rounded-lg border text-xs bg-white hover:bg-gray-50" data-edit="${n.id}">편집</button>
            <button class="ml-1 px-2 py-1 rounded-lg border text-xs bg-white hover:bg-gray-50" data-del="${n.id}">삭제</button>
          </td>
        </tr>
      `).join('');

      empty.classList.toggle('hidden', rows.length > 0);
    }

    // ---- events ----
    $('#new').addEventListener('click', () => openEditor());

    $('#q').addEventListener('input', (e) => {
      state.filter.q = e.target.value;
      render();
    });
    $('#sort').addEventListener('change', (e) => {
      state.filter.sort = e.target.value;
      render();
    });

    tbody.addEventListener('click', (e) => {
      const t = e.target;
      if (t.dataset.edit) {
        const note = state.notes.find(x => x.id === t.dataset.edit);
        openEditor(note);
      } else if (t.dataset.del) {
        const id = t.dataset.del;
        if (confirm('삭제할까요?')) {
          state.notes = state.notes.filter(x => x.id !== id);
          persist(); render();
        }
      }
    });

    const dlg = $('#dlg'), title = $('#title'), body = $('#body'), pv = $('#preview'), pvBtn = $('#preview-toggle');
    pvBtn.addEventListener('click', () => {
      pv.classList.toggle('hidden');
      pv.querySelector('.md').innerHTML = md(body.value);
    });
    body.addEventListener('input', () => {
      if (!pv.classList.contains('hidden')) {
        pv.querySelector('.md').innerHTML = md(body.value);
      }
    });
    $('#save').addEventListener('click', (e) => {
      e.preventDefault();
      saveEditor();
      dlg.close();
    });

    function openEditor(note=null) {
      state.editingId = note?.id || null;
      $('#dlg-title').textContent = note ? '노트 편집' : '새 노트';
      title.value = note?.title || '';
      body.value = note?.body || '';
      pv.classList.add('hidden');
      dlg.showModal();
    }
    function saveEditor() {
      const now = Date.now();
      if (state.editingId) {
        const n = state.notes.find(x => x.id === state.editingId);
        n.title = title.value.trim();
        n.body = body.value;
        n.updatedAt = now;
      } else {
        state.notes.unshift({
          id: crypto.randomUUID(),
          title: title.value.trim(),
          body: body.value,
          createdAt: now,
          updatedAt: now
        });
      }
      persist(); render();
    }

    // ---- export/import ----
    $('#export-json').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state.notes, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'notes.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    $('#export-md').addEventListener('click', () => {
      const out = state.notes.map(n => {
        const h = `# ${n.title || '(제목 없음)'}\n_Updated: ${fmt(n.updatedAt||n.createdAt)}_\n\n`;
        return h + (n.body || '') + '\n\n---\n';
      }).join('\n');
      const blob = new Blob([out], {type:'text/markdown'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'notes.md';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    $('#import-json').addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      try {
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('Array expected');
        // 간단 병합: 새 항목을 앞쪽에 추가
        const exist = new Map(state.notes.map(n => [n.id, n]));
        for (const n of arr) {
          if (!n.id) n.id = crypto.randomUUID();
          if (exist.has(n.id)) continue;
          state.notes.unshift(n);
        }
        persist(); render();
        alert('가져오기가 완료되었습니다.');
      } catch (err) {
        alert('JSON 형식이 올바르지 않습니다.');
      } finally {
        e.target.value = '';
      }
    });

    // init
    render();
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
